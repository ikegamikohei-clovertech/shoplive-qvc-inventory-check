# QVC在庫チェッカー 仕様書

## 概要

QVC Japan POP-UP LIVE（Shoplive利用）配信中の商品在庫をリアルタイムで監視し、Shoplive上の在庫ステータスに自動反映するプログラムです。

---

## 動作タイミング

- **毎日 19:50 JST** にGitHub Actionsが自動起動
- Shoplive APIから当日のライブスケジュールを確認
- **ライブ予定がない日は即終了**（不要なAPI呼び出しなし）
- ライブ予定がある場合、**開始5分前から終了5分後まで2分間隔**で在庫チェックを実行
- 手動実行も可能（GitHub Actions画面から「Run workflow」）

---

## 対象キャンペーン

以下の条件に該当するShopliveキャンペーンが対象となります。

- **ONAIR**（配信中）の全キャンペーン
- **READY**（配信準備完了）で、開始予定時刻が10分以内のキャンペーン

---

## 処理フロー

```
1. Shoplive APIから対象キャンペーンを取得
2. キャンペーンに登録されている商品リストを取得
3. 各商品のURLからQVC商品IDを抽出
4. QVC Japan商品ページから各商品の全SKU（カラー×サイズ）在庫情報を取得
5. 在庫状況に応じてShoplive上の在庫ステータスを更新
6. 全SKU在庫情報をJSONファイルに出力（OBS表示用）
```

※ 在庫情報はQVC Japanウェブサイト（qvc.jp）の商品ページから取得しています。QVCが公式に提供するAPIではなく、サイト内部で使用されている商品情報を参照しているため、QVC側の仕様変更により取得できなくなる可能性があります。

---

## 在庫ステータス判定ルール

QVC Japan商品ページから取得した各SKUの在庫値（ats）をもとに、商品全体のステータスを判定します。

| QVC在庫値 | 意味 |
|---|---|
| `Y` | 在庫あり |
| `L` | 残りわずか |
| `N` | 在庫なし |

| 判定条件 | Shoplive反映ステータス |
|---|---|
| 全SKUが `N` | **SOLD_OUT** |
| 1つ以上 `L` あり | **LOW_IN_STOCK** |
| 上記以外（`Y` が存在） | **IN_STOCK** |

※ QVC ECサイト上の在庫表示と同一の定義です。

---

## タイムライン例（20:00 JSTライブ開始の場合）

| 時刻 | 動作 |
|---|---|
| 19:50 | プログラム起動、スケジュール確認 |
| 19:55 | チェック開始（READY状態のキャンペーンを検出） |
| 20:00 | ライブ開始、ONAIRキャンペーンとして在庫監視継続 |
| 20:00〜21:05 | 2分間隔で在庫チェック＆Shoplive更新 |
| 21:05 | 終了時刻＋5分経過、プログラム終了 |

---

## 出力データ（OBS用）

在庫チェックのたびに以下のJSONファイルを更新します。

**ファイル:** `output/stock_status.json`

```json
{
  "updated_at": "2026-02-22T20:05:00+09:00",
  "campaign": "キャンペーン名",
  "products": [
    {
      "name": "商品名",
      "product_id": "751067",
      "overall_status": "IN_STOCK",
      "variants": [
        {"color": "ブラック", "size": "S", "ats": "Y"},
        {"color": "ブラック", "size": "M", "ats": "N"},
        {"color": "グレー", "size": "S", "ats": "L"}
      ]
    }
  ]
}
```
