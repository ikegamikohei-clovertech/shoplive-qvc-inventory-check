# QVC在庫チェッカー 仕様書

## 概要

QVC Japan POP-UP LIVE（Shoplive利用）配信中の商品在庫をリアルタイムで監視し、Shoplive上の在庫ステータスに自動反映するプログラムです。在庫情報はOBS用のHTMLオーバーレイとしても配信画面に表示できます。

---

## 動作タイミング

- **毎日 19:50 JST** にGitHub Actionsが自動起動
- Shoplive APIから当日のライブスケジュールを確認
- **ライブ予定がない日は即終了**（不要なAPI呼び出しなし）
- ライブ予定がある場合、**開始5分前から終了5分後まで2分間隔**で在庫チェックを実行
- 手動実行も可能（GitHub Actions画面から「Run workflow」）

---

## 対象キャンペーン

以下の条件に該当するShopliveキャンペーンが対象となります。

- **ONAIR**（配信中）の全キャンペーン
- **READY**（配信準備完了）で、開始予定時刻が10分以内のキャンペーン

---

## 処理フロー

```
1. Shoplive APIから対象キャンペーンを取得
2. キャンペーンに登録されている商品リストを取得
3. 各商品のURLからQVC商品IDを抽出
4. QVC Japan商品ページから各商品の全SKU（カラー×サイズ）在庫情報を取得
5. 在庫状況に応じてShoplive上の在庫ステータスを更新
6. 全SKU在庫情報をJSON出力 → GitHub Pages経由でOBS表示に反映
```

※ 在庫情報はQVC Japanウェブサイト（qvc.jp）の商品ページから取得しています。QVCが公式に提供するAPIではなく、サイト内部で使用されている商品情報を参照しているため、QVC側の仕様変更により取得できなくなる可能性があります。

---

## 在庫ステータス判定ルール

QVC Japan商品ページから取得した各SKUの在庫値（ats）をもとに、商品全体のステータスを判定します。

| QVC在庫値 | 意味 |
|---|---|
| `Y` | 在庫あり |
| `L` | 残りわずか |
| `N` | 在庫なし |

| 判定条件 | Shoplive反映ステータス |
|---|---|
| 全SKUが `N` | **SOLD_OUT** |
| 1つ以上 `L` あり | **LOW_IN_STOCK** |
| 上記以外（`Y` が存在） | **IN_STOCK** |

※ QVC ECサイト上の在庫表示と同一の定義です。

---

## タイムライン例（20:00 JSTライブ開始の場合）

| 時刻 | 動作 |
|---|---|
| 19:50 | プログラム起動、スケジュール確認 |
| 19:55 | チェック開始（READY状態のキャンペーンを検出） |
| 20:00 | ライブ開始、ONAIRキャンペーンとして在庫監視継続 |
| 20:00〜21:05 | 2分間隔で在庫チェック＆Shoplive更新＆OBS用データ更新 |
| 21:05 | 終了時刻＋5分経過、プログラム終了 |

---

## OBS表示（GitHub Pages連携）

在庫情報はGitHub Pagesで公開され、OBSのブラウザソースから読み込んで配信画面にオーバーレイ表示できます。

### 公開URL

| 種類 | URL |
|---|---|
| HTML表示 | `https://ikegamikohei-clovertech.github.io/shoplive-qvc-inventory-check/` |
| JSONデータ | `https://ikegamikohei-clovertech.github.io/shoplive-qvc-inventory-check/stock_status.json` |

### OBSでの設定方法

1. OBSで「ソース」→「＋」→「**ブラウザ**」を追加
2. URLに上記のHTML表示URLを入力
3. 幅: `1080`、高さ: `300` に設定
4. 配信画面上の表示位置を調整

### 表示内容

- 商品名、カラー×サイズごとの在庫状況を表示
- 在庫あり: 〇（緑）、残りわずか: △（黄）、在庫なし: ✖（赤）
- **4秒ごと**に商品・ページが自動切り替え
- **2分ごと**にJSONデータを自動再取得（ライブ中の在庫変動を反映）

---

## セットアップ手順

### 1. GitHub Secrets の設定

リポジトリの Settings → Secrets and variables → Actions で以下を追加：

| Secret名 | 値 |
|---|---|
| `SHOPLIVE_ACCESS_KEY` | Shopliveのアクセスキー |
| `SHOPLIVE_SECRET_KEY` | Shopliveの認証トークン（JWT） |

### 2. GitHub Pages の有効化

1. リポジトリの **Settings → Pages** を開く
2. Source: 「**Deploy from a branch**」を選択
3. Branch: 「**gh-pages**」 / 「**/ (root)**」を選択
4. **Save** をクリック
5. 1〜2分後にURLが有効になる

### 3. 動作確認

- GitHub Actions タブから「**Run workflow**」で手動実行
- ログで「対象キャンペーンなし」または在庫チェック結果が表示されることを確認
- GitHub PagesのURLにアクセスし、OBS表示が動作することを確認

---

## 出力データ定義（stock_status.json）

### トップレベル

| フィールド | 型 | 説明 |
|---|---|---|
| `updated_at` | string | 最終更新日時（ISO 8601、JST） |
| `campaign` | string | Shopliveキャンペーン名 |
| `products` | array | 商品リスト |

### products[]

| フィールド | 型 | 説明 |
|---|---|---|
| `name` | string | 商品名 |
| `product_id` | string | QVC商品ID |
| `overall_status` | string | 商品全体の在庫ステータス（`IN_STOCK` / `LOW_IN_STOCK` / `SOLD_OUT`） |
| `variants` | array | SKU（カラー×サイズ）ごとの在庫情報 |

### variants[]

| フィールド | 型 | 説明 |
|---|---|---|
| `color` | string | カラー名（例: "ブラック"） |
| `size` | string | サイズ名（例: "M", "XS/69cm"）。サイズなし商品は空文字 |
| `ats` | string | SKU単位の在庫状態（`Y`: 在庫あり / `L`: 残りわずか / `N`: 在庫なし） |

### サンプル

```json
{
  "updated_at": "2026-02-22T20:05:00+09:00",
  "campaign": "この春マスト！アンコキーヌの主役級トレンチ",
  "products": [
    {
      "name": "ANNE COQUINE ストレッチツイルショートトレンチコート",
      "product_id": "751067",
      "overall_status": "IN_STOCK",
      "variants": [
        {"color": "ブラック", "size": "S", "ats": "Y"},
        {"color": "ブラック", "size": "M", "ats": "Y"},
        {"color": "ブラック", "size": "L", "ats": "N"},
        {"color": "グレージュ", "size": "S", "ats": "L"}
      ]
    }
  ]
}
```
